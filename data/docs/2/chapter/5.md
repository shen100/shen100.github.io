---
theme: channing-cyan
---
# 在 macOS 上使用 mitmproxy 透明代理进行网络抓包

## Macbook 共享WIFI给iPhone
在系统设置中，输入`共享`, 找到`互联网共享`
<img src="/image/docs/2/10.jpg" style="width: 500px;"> 


打开互联网共享, 共享以下来源的连接，选择Wi-Fi, 使用以下端口共享给设备，把iPhone USB都选上。
<img src="/image/docs/2/11.jpg" style="width: 500px;">


## 以 transparent 模式运行 mitmweb
```
mitmweb --mode transparent --listen-port 7777  -s proxy.py
```


```
sudo echo "rdr pass on bridge100 inet proto tcp to any port {80, 443} -> 192.168.2.1 port 7777" | sudo pfctl -ef -
```
* `rdr` (redirect)：表示端口转发（NAT 重定向）。

* `pass`：允许匹配的流量通过（即使其他规则可能阻止它）。

* `on bridge100`：仅对名为 bridge100 的网络接口生效（通常是虚拟网桥，如 VMware/VirtualBox 或 macOS 的共享网络接口）。

* `inet proto tcp`：仅处理 IPv4 (inet) 的 TCP 协议流量。

* `to any port {80, 443}`：匹配目标端口为 80（HTTP）或 443（HTTPS）的流量。

* `-> 192.168.2.1 port 7777`：将匹配的流量重定向到 192.168.2.1 的 9999 端口。
* **作用**：所有通过 bridge100 接口的 HTTP/HTTPS 流量会被转发到 192.168.2.1:9999

### 清空所有 NAT/重定向规则
```
sudo pfctl -F nat -f /etc/pf.conf
```
* `-F nat`：清空所有 NAT/重定向规则（rdr 属于 NAT 规则）。

* `-f /etc/pf.conf`：重新加载默认的 PF 配置文件（如果存在）。

* **效果**：这会删除所有临时添加的 `rdr` 规则，但保留 `/etc/pf.conf` 中的持久化规则。


## 查看 流量转发（IP Forwarding） 是否开启
```
sysctl net.inet.ip.forwarding
```

## 查看当前生效的 NAT（网络地址转换）规则
```
sudo pfctl -s nat
```
输出如下
```
No ALTQ support in kernel
ALTQ related functions disabled
rdr pass on bridge100 inet proto tcp from any to any port = 80 -> 127.0.0.1 port 7777
rdr pass on bridge100 inet proto tcp from any to any port = 443 -> 127.0.0.1 port 7777
```


